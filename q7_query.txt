EJSON.stringify(db.sales.aggregate([{$unwind:"$items"},{$group:{_id:{orderId:"$_id",purchaseMethod:"$purchaseMethod"},distinctItems:{$addToSet:"$items.name"}}},{$project:{purchaseMethod:"$_id.purchaseMethod",countDistinct:{$size:"$distinctItems"}}},{$group:{_id:"$purchaseMethod",avg_distinct_items:{$avg:"$countDistinct"}}},{$project:{_id:0,purchaseMethod:"$_id",avg_distinct_items:{$round:["$avg_distinct_items",2]}}},{$sort:{avg_distinct_items:-1,purchaseMethod:1}}]).toArray(), null, 0)
